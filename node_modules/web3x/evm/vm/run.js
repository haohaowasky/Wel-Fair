"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const opcodes_1 = require("../opcodes");
async function run(context, printOpcodes = false) {
    while (!context.halt) {
        const { code, ip } = context;
        const byte = code[context.ip];
        const opCode = opcodes_1.OpCodes[byte];
        if (!opCode) {
            throw new Error(`Unknown opcode 0x${byte.toString(16)}`);
        }
        if (printOpcodes) {
            const opCodeParams = code.slice(ip + 1, ip + opCode.bytes);
            // tslint:disable-next-line:no-console
            console.log(opCode.toString(opCodeParams));
        }
        await opCode.handle(context);
    }
    if (context.reverted) {
        let instruction = 0;
        for (let bytes = 0; bytes < context.ip; ++instruction) {
            const { code } = context;
            const byte = code[bytes];
            const opCode = opcodes_1.OpCodes[byte];
            if (!opCode) {
                throw new Error(`Unknown opcode 0x${byte.toString(16)}`);
            }
            bytes += opCode.bytes;
        }
        context.revertInstruction = instruction;
        // tslint:disable-next-line:no-console
        console.error(`Execution reverted at instruction ${instruction}.`);
    }
    return context;
}
exports.run = run;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2V2bS92bS9ydW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx3Q0FBcUM7QUFHOUIsS0FBSyxVQUFVLEdBQUcsQ0FBQyxPQUFtQixFQUFFLGVBQXdCLEtBQUs7SUFDMUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7UUFDcEIsTUFBTSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFDN0IsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM5QixNQUFNLE1BQU0sR0FBRyxpQkFBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTdCLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxNQUFNLElBQUksS0FBSyxDQUFDLG9CQUFvQixJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMxRDtRQUVELElBQUksWUFBWSxFQUFFO1lBQ2hCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNELHNDQUFzQztZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztTQUM1QztRQUVELE1BQU0sTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUM5QjtJQUVELElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRTtRQUNwQixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFDcEIsS0FBSyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLE9BQU8sQ0FBQyxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUU7WUFDckQsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQztZQUN6QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDekIsTUFBTSxNQUFNLEdBQUcsaUJBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3QixJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNYLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQW9CLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQzFEO1lBQ0QsS0FBSyxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUM7U0FDdkI7UUFDRCxPQUFPLENBQUMsaUJBQWlCLEdBQUcsV0FBVyxDQUFDO1FBQ3hDLHNDQUFzQztRQUN0QyxPQUFPLENBQUMsS0FBSyxDQUFDLHFDQUFxQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0tBQ3BFO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQXBDRCxrQkFvQ0MifQ==